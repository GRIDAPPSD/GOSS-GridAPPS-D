#!/usr/bin/env python3

"""
Script for building the gridappsd container.

This script pulls the gridappsd_base docker image, cleans the project, exports the project, and builds the gridappsd container.

Usage:
    python build-gridappsd-container [--base-version <base_version>] [--output-version <output_version>]

Arguments:
    base-version (str, optional): The version of the gridappsd_base docker image. Default is "rc2".
    output-version (str, optional): The output tag version for local development. Default is "local".

Example:
    python build-gridappsd-container.py --base-version rc2 --output-version local

"""

import argparse
import subprocess
import shutil


def execute(cmd: str | list[str], shell: bool = False):
    """
    Executes a command in the shell and prints the output.

    Args:
        cmd (str | list[str]): The command to execute. If a string and shell=False, it will be split into a list of arguments.
        shell (bool): Whether to execute the command through the shell.

    Raises:
        subprocess.CalledProcessError: If the command returns a non-zero exit code.

    """
    if not shell and isinstance(cmd, str):
        cmd = cmd.split(" ")

    with subprocess.Popen(cmd, stdout=subprocess.PIPE, universal_newlines=True, shell=shell) as p:
        for line in iter(p.stdout.readline, ""):
            if line.strip():
                print(line.strip())

    p.wait()
    if p.returncode:
        if isinstance(cmd, list):
            raise subprocess.CalledProcessError(p.returncode, cmd=" ".join(cmd))
        else:
            raise subprocess.CalledProcessError(p.returncode, cmd=cmd)
            
            

if __name__ == '__main__':
    
    parser = argparse.ArgumentParser()

    parser.add_argument("--base-version", "--base_version", dest="base_version", default="rc2",
                        help="The gridappsd_base docker image version (default: rc2)")
    parser.add_argument("--output-version", "--output_version", dest="output_version", default="local",
                        help="The output tag version for local development (default: local)")
    parser.add_argument("--pull", action="store_true",
                        help="Force pull base image from registry even if it exists locally")

    opts = parser.parse_args()

    # Check if we should pull the base image
    if opts.pull:
        print(f"Pulling gridappsd/gridappsd_base:{opts.base_version} from registry (--pull specified)...")
        execute(f"docker pull gridappsd/gridappsd_base:{opts.base_version}")
    else:
        # Check if base image exists locally, pull only if not found
        result = subprocess.run(
            f"docker image inspect gridappsd/gridappsd_base:{opts.base_version}".split(),
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
        if result.returncode != 0:
            print(f"Local image gridappsd/gridappsd_base:{opts.base_version} not found, pulling from registry...")
            execute(f"docker pull gridappsd/gridappsd_base:{opts.base_version}")
        else:
            print(f"Using local image gridappsd/gridappsd_base:{opts.base_version}")

    execute("./gradlew clean")
    shutil.rmtree("build/launcher", ignore_errors=True)
    execute("./gradlew dist")
    execute(f"docker build --build-arg GRIDAPPSD_BASE_VERSION=:{opts.base_version} --build-arg TIMESTAMP=$(date +%Y%m%d%H%M%S) --network=host -t gridappsd/gridappsd:{opts.output_version} .", shell=True)
